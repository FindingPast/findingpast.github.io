<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Export Video Preview</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #d0f0ff;
      color: #005c6c;
      padding: 40px;
      text-align: center;
    }

    button {
      background-color: #00897b;
      border: none;
      padding: 12px 20px;
      color: white;
      border-radius: 20px;
      cursor: pointer;
      font-size: 16px;
    }

    video {
      margin-top: 30px;
      width: 640px;
      max-width: 90%;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <h2>Export Video Preview</h2>
  <p>Click the button below to generate a video preview using your images and music.</p>
  <button onclick="generateVideo()">Download Video</button>
  <div id="status"></div>
  <video id="videoPreview" controls></video>

  <script type="module">
    import { createFFmpeg, fetchFile } from 'https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js';

    const ffmpeg = createFFmpeg({
      corePath: 'https://drive.google.com/uc?export=download&id=1y4OQNs7g7l-wcUreyJZVa_hnPmZAEwbI',
      wasmPath: 'https://drive.google.com/uc?export=download&id=1zUnYZa7yhNlJYTsCM8r0YxdMR_eyeTGY',
      workerPath: 'https://drive.google.com/uc?export=download&id=1R9AEcbsxSJrL1iI-pEL8DkQ6JQj8gpGM',
      log: true
    });

    async function generateVideo() {
      const status = document.getElementById("status");
      const preview = document.getElementById("videoPreview");
      status.innerText = "Loading FFmpeg...";

      await ffmpeg.load();

      // Placeholder assets: you can change these
      const images = [
        "https://findingpast.github.io/assets/images/Vibes.jpeg",
        "https://findingpast.github.io/assets/images/Open.jpeg",
        "https://findingpast.github.io/assets/images/Life.jpeg"
      ];

      const musicURL = "https://findingpast.github.io/assets/music/yume 2kki - lotus waters.mp3";

      status.innerText = "Fetching files...";
      for (let i = 0; i < images.length; i++) {
        const imgData = await fetchFile(images[i]);
        ffmpeg.FS('writeFile', `image${i}.jpg`, imgData);
      }

      const musicData = await fetchFile(musicURL);
      ffmpeg.FS('writeFile', 'audio.mp3', musicData);

      const inputTxt = images.map((_, i) => `file 'image${i}.jpg'\nduration 5`).join('\n') + '\nfile \'image2.jpg\'\n'; // final still
      ffmpeg.FS('writeFile', 'input.txt', inputTxt);

      status.innerText = "Encoding video...";

      await ffmpeg.run(
        '-f', 'concat',
        '-safe', '0',
        '-i', 'input.txt',
        '-i', 'audio.mp3',
        '-vf', 'scale=1280:720:force_original_aspect_ratio=decrease,pad=1280:720:(ow-iw)/2:(oh-ih)/2',
        '-shortest',
        '-c:v', 'libx264',
        '-c:a', 'aac',
        '-pix_fmt', 'yuv420p',
        'output.mp4'
      );

      const data = ffmpeg.FS('readFile', 'output.mp4');
      const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
      preview.src = url;
      status.innerText = "Done! Video ready.";
    }
  </script>
</body>
</html>
