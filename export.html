<!DOCTYPE html>
<html>
<head>
  <title>Export Video Preview</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #e1f5fe;
      padding: 20px;
      color: #004d40;
    }
    h1 {
      color: #00796b;
    }
    button {
      padding: 10px 20px;
      background-color: #009688;
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
    }
    video {
      display: block;
      margin-top: 20px;
      max-width: 720px;
      width: 100%;
    }
  </style>
</head>
<body>
  <h1>Export Video Preview</h1>
  <p>Click the button below to generate a video preview using your images and music.</p>
  <button onclick="generateVideo()">Download Video</button>
  <video id="outputVideo" controls style="display:none;"></video>

  <!-- âœ… Import known working ffmpeg.wasm build -->
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.10.1/dist/ffmpeg.min.js"></script>

  <script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({
      log: true,
      corePath: 'https://rawcdn.githack.com/ffmpegwasm/ffmpeg.wasm-core/0.10.0/dist/ffmpeg-core.js'
    });

    const imageUrls = [
      "https://raw.githubusercontent.com/FindingPast/frutiger-aero/main/images/Vibes.jpeg",
      "https://raw.githubusercontent.com/FindingPast/frutiger-aero/main/images/Open.jpeg",
      "https://raw.githubusercontent.com/FindingPast/frutiger-aero/main/images/Life.jpeg"
    ];
    const audioUrl = "https://raw.githubusercontent.com/FindingPast/frutiger-aero/main/music/yume%202kki%20-%20lotus%20waters.mp3";

    async function generateVideo() {
      if (!ffmpeg.isLoaded()) await ffmpeg.load();

      const audioData = await fetchFile(audioUrl);
      ffmpeg.FS('writeFile', 'music.mp3', audioData);

      for (let i = 0; i < imageUrls.length; i++) {
        const imgData = await fetchFile(imageUrls[i]);
        const padded = String(i + 1).padStart(3, '0');
        ffmpeg.FS('writeFile', `img${padded}.jpg`, imgData);
      }

      await ffmpeg.run(
        '-framerate', '1/5',
        '-i', 'img%03d.jpg',
        '-i', 'music.mp3',
        '-c:v', 'libx264',
        '-r', '30',
        '-pix_fmt', 'yuv420p',
        '-shortest',
        'output.mp4'
      );

      const data = ffmpeg.FS('readFile', 'output.mp4');
      const video = document.getElementById('outputVideo');
      video.src = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
      video.style.display = 'block';
    }

    // Make function globally accessible
    window.generateVideo = generateVideo;
  </script>
</body>
</html>
