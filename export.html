<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Export Video - Frutiger Aero</title>
  <style>
    body {
      font-family: sans-serif;
      background: linear-gradient(to bottom right, #b3e5fc, #e1f5fe);
      text-align: center;
      padding: 20px;
    }
    video {
      width: 100%;
      max-width: 720px;
      margin: 20px auto;
      display: none;
    }
    button {
      background-color: #00796b;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover {
      background-color: #004d40;
    }
  </style>
</head>
<body>
  <h1>Export Video</h1>
  <p>This preview will simulate the final export.</p>
  <video id="preview" controls></video>
  <br>
  <button onclick="generateVideo()">Download Final Video</button>

  <script type="module">
    import { createFFmpeg, fetchFile } from 'https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.9/dist/esm/index.js';

    const ffmpeg = createFFmpeg({
      log: true,
      corePath: 'https://www.dropbox.com/scl/fi/jkl6s38r5qpe5vntjxs53/ffmpeg-core.js?rlkey=tgbq09222ov0kwvhhyrws7tr7&raw=1',
      wasmPath: 'https://www.dropbox.com/scl/fi/mghtnmzceuwda4wd1hkkq/ffmpeg-core.wasm?rlkey=5syhn78kcifeef45xtrh1gmt3&raw=1',
      workerPath: 'https://www.dropbox.com/scl/fi/c2p567br6oe5t1nctzo7p/ffmpeg-core.worker.js?rlkey=4hk533iv4zqxnhyg6lxkbcjoh&raw=1'
    });

    async function generateVideo() {
      const images = [
        'https://findingpast.github.io/assets/Vibes.jpg',
        'https://findingpast.github.io/assets/Open.jpg',
        'https://findingpast.github.io/assets/Life.jpg',
        'https://findingpast.github.io/assets/Gallery.jpg',
        'https://findingpast.github.io/assets/Frutiger-Eco.jpg'
      ];
      const audioUrl = 'https://findingpast.github.io/assets/music.mp3';

      if (!ffmpeg.isLoaded()) {
        await ffmpeg.load();
      }

      for (let i = 0; i < images.length; i++) {
        const imgBlob = await fetch(images[i]).then(res => res.blob());
        ffmpeg.FS('writeFile', `img${i}.jpg`, await fetchFile(imgBlob));
      }

      const audioBlob = await fetch(audioUrl).then(res => res.blob());
      ffmpeg.FS('writeFile', 'music.mp3', await fetchFile(audioBlob));

      const inputTxt = images.map((_, i) => `file 'img${i}.jpg'\nduration 5`).join('\n') + `\nfile 'img${images.length - 1}.jpg'`;
      ffmpeg.FS('writeFile', 'input.txt', inputTxt);

      await ffmpeg.run(
        '-f', 'concat',
        '-safe', '0',
        '-i', 'input.txt',
        '-i', 'music.mp3',
        '-vf', 'scale=1280:720:force_original_aspect_ratio=decrease,pad=1280:720:(ow-iw)/2:(oh-ih)/2',
        '-c:v', 'libx264',
        '-pix_fmt', 'yuv420p',
        '-shortest',
        'output.mp4'
      );

      const data = ffmpeg.FS('readFile', 'output.mp4');
      const videoUrl = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));

      const preview = document.getElementById('preview');
      preview.src = videoUrl;
      preview.style.display = 'block';

      const a = document.createElement('a');
      a.href = videoUrl;
      a.download = 'frutiger-aero-export.mp4';
      a.click();
    }
  </script>
</body>
</html>
